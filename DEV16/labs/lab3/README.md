# Lab 3: React with Event-Driven Ansible (EDA)

## Overview

In this lab, you will learn how to leverage the Event Streams API via the `crowdstrike.falcon.eventstreams` Event-Driven Ansible (EDA) source to monitor and respond to CrowdStrike Falcon events in near real-time*.

> [!IMPORTANT]
> Please note that events are not guaranteed to be delivered in real-time. The time it takes for an event to be delivered can vary based on the current load on the CrowdStrike Event Streams service along with other factors.

## Objectives

By the end of this lab, you will be able to:

- Understand the potential for using EDA to monitor and respond to CrowdStrike Falcon events
- Create rules and conditions to filter events
- Respond to events using Ansible playbooks

## Steps

1. Navigate to the `labs/lab3` directory to begin the lab.

    ```bash
    cd ~/labs/lab3
    ```

1. Review the structure of the lab directory by typing the `tree` command

    ```terminal
    .
    ├── README.md
    ├── inventory
    ├── logs
    ├── playbooks
    │   ├── debug-containment.yml
    │   └── host-contain.yml
    └── rulebooks
        ├── detection-demo.yml
        └── detection-example.yml
    ```

This lab consists of a `rulebooks` directory that contains two EDA rulebooks that will be used to demonstrate how to monitor and respond to CrowdStrike Falcon events using EDA. The `playbooks` directory contains Ansible playbooks that will show high-level examples of how to respond to events. There is also a `logs` directory used to store the logs generated by the `host-contain.yml` playbook.

## Rulebooks

> [!IMPORTANT]
> EDA Rulebooks are not to be confused with Ansible playbooks. Even though they follow a similar structure, Rulebooks operate separately from Ansible core itself.

Rulebooks in EDA are YAML files that define how your system should respond to events. They are broken out into three main sections:

- **Sources**: Define the sources of events that you want to monitor
- **Rules**: Define the conditions that must be met for an event to trigger a response
- **Actions**: Define the actions that should be taken when an event meets the conditions defined in the rules

> [!NOTE]
> For more information on rulebooks, see the [EDA documentation](https://ansible.readthedocs.io/projects/rulebook/en/latest/introduction.html#why-rulebooks).

### Example Detection Events Rulebook

Now that we have a basic understanding of rulebooks, let's take a look at the `detection-example.yml` rulebook in the `rulebooks` directory.

Review the contents of the `detection-example.yml` rulebook

```bash
cat rulebooks/detection-example.yml
```

You can see that for the **source**, we are using the `crowdstrike.falcon.eventstreams` source. This source will allow us to monitor CrowdStrike Falcon events by tapping into the Event Streams API.

> For more information on the `crowdstrike.falcon.eventstreams` source, see the [documentation](https://github.com/CrowdStrike/ansible_collection_falcon/blob/main/docs/crowdstrike.falcon.eventstream.md).

The **rule** defined in this rulebook is looking for any event that matches the alias of your lab environment. This is defined in the `conditions` section of the rulebook.

The **action** here is using the debug action to print out a formatted message of any event that matches the conditions defined in the rule.

#### Running the Detection Example Rulebook

Let's run the `detection-example.yml` rulebook to see how it works.

```bash
ansible-rulebook -i inventory -r rulebooks/detection-example.yml -E FALCON_CLIENT_ID,FALCON_CLIENT_SECRET -v | tee output.txt
```

Recall that this is different from running an Ansible playbook. To pass in the required environment variables, we are using the `-E` flag followed by the environment variables that need to be set.

At this point, we shouldn't see any output. This is because we haven't triggered any events that match the conditions defined in the rulebook.

##### Triggering an Event

Hop over to your **`sketchy-cat1`** vm and run the following command to generate an event that matches the conditions defined in the rulebook.

```bash
bash crowdstrike_test_low > /dev/null 2>&1
```

> This command generates an Overwatch severity level low event that matches the conditions defined in the rulebook.

Now come back to the **`ansible`** vm and let's wait for the event to be delivered. Once the event is delivered, you should see the event printed out in the terminal.

> [!NOTE]
> Recall that this is not real-time and the time it takes for an event to be delivered can vary.

Cancel the rulebook execution by pressing `Ctrl + C` to stop the rulebook execution.

---

### Demo Detection Events Rulebook

Now that we have seen how the `detection-example.yml` rulebook works, let's take a look at the `detection-demo.yml` rulebook in the `rulebooks` directory.

Review the contents of the `detection-demo.yml` rulebook

```bash
cat rulebooks/detection-demo.yml
```

> For more information surrounding Event Types, see the following [CrowdStrike documentation](https://falcon.crowdstrike.com/login/?unilogin=true&next=/documentation/page/d88d9ed6/streaming-api-event-dictionary).

This rulebook is similar to the `detection-example.yml` rulebook, but it has a few additional conditions defined in the rule section and an extra event type to include.

#### Rule 1

What we are defining now is that we only want to respond to detection events that are from our lab environment and have a severity greater than a Medium severity level.

The action defined if the condition matches is to run the `host-contain.yml` playbook located in the `playbooks` directory. This playbook will contain the logic to log the information in a way that a security analyst could review, and then contain the host using the `crowdstrike.falcon.host_contain` Ansible module.

Review the contents of the `host-contain.yml` playbook

```bash
less playbooks/host-contain.yml
```

#### Rule 2

We also have another rule that is watching for containment events. These events belong to the `UserActivityAuditEvent` event type.

The action defined if the condition matches is to run the `debug-containment.yml` playbook located in the `playbooks` directory. This playbook will print out the event information in a formatted way.

Review the contents of the `debug-containment.yml` playbook

```bash
cat playbooks/debug-containment.yml
```

> [!TIP]
> Think of all the different ways you could respond to an event. The possibilities are endless! A slack message, a ServiceNow ticket, a cloud provider action, etc.

#### Running the Detection Demo Rulebook

Let's run the `detection-demo.yml` rulebook to see it in action

```bash
ansible-rulebook -i inventory -r rulebooks/detection-demo.yml -E FALCON_CLIENT_ID,FALCON_CLIENT_SECRET -v | tee output.txt
```

Just like before, we shouldn't see any output. This is because we haven't triggered any events that match the conditions defined in the rulebook.

##### Triggering an Event

Hop over to your **`sketchy-cat1`** vm and run the following command to generate an event that matches the conditions defined in the rulebook.

```bash
bash crowdstrike_test_high > /dev/null 2>&1
```

> This command generates an Overwatch severity level high event that matches the conditions defined in the rulebook.

Now come back to the **`ansible`** vm and let's wait for the event to be delivered. Once the event is delivered, you should see the `host_contain.yml` playbook being executed.

Since the `host_contain.yml` playbook attempts to contain the host, we should also see the `debug-containment.yml` playbook being executed once the event is delivered.

##### Review the Log

Cancel the rulebook execution by pressing `Ctrl + C` and review the log file that was created.

```bash
less logs/*sketchy-cat1*.log
```

##### Verify the Host Containment

Open the CrowdStrike Falcon console and navigate to the **`Endpoint security`** --> **`Endpoint detections`** section and filter by either your host or tag. Click on the detection and browse around. Notice on the right hand pane, if you scroll down to Host you will see the host is currently **Contained**!

You could also try going to the the **`sketchy-cat1`** vm and seeing if it's responsive.

##### Lift the Containment

Let's run the `detection-demo.yml` rulebook again to see the containment being lifted.

```bash
ansible-rulebook -i inventory -r rulebooks/detection-demo.yml -E FALCON_CLIENT_ID,FALCON_CLIENT_SECRET -v
```

In the console, select the `Lift Containment` option to lift the containment on the host.

You should see the `debug-containment.yml` playbook being executed once the event is delivered.

press `Ctrl + C` to stop the rulebook execution.

---
Congratulations! You have successfully monitored and responded to CrowdStrike Falcon detection events using EDA.
